/****** Script for SelectTopNRows command from SSMS  ******/

IF OBJECT_ID('tempdb..#TempTable') IS NOT NULL
    DROP TABLE #TempTable;

CREATE TABLE #TempTable(
LoanSkey Varchar(20),
ActionDay datetime)
;

INSERT INTO #TempTable values
('225340','03/06/2023'),
('226160','03/06/2023'),
('226277','03/06/2023'),
('226332','03/06/2023'),
('226433','03/06/2023'),
('227009','03/06/2023'),
('227054','03/06/2023'),
('227088','03/06/2023'),
('227493','03/06/2023'),
('227550','03/06/2023'),
('227554','03/06/2023'),
('227570','03/06/2023'),
('227589','03/06/2023'),
('227606','03/06/2023'),
('227607','03/06/2023'),
('227692','03/06/2023'),
('227718','03/06/2023'),
('227836','03/06/2023'),
('227920','03/06/2023'),
('227925','03/06/2023'),
('227930','03/06/2023'),
('228104','03/06/2023'),
('228146','03/06/2023'),
('228195','03/06/2023'),
('228206','03/06/2023'),
('228723','03/06/2023'),
('228735','03/06/2023'),
('228738','03/06/2023'),
('228785','03/06/2023'),
('228794','03/06/2023'),
('228810','03/06/2023'),
('228825','03/06/2023'),
('228845','03/06/2023'),
('228916','03/06/2023'),
('228957','03/06/2023'),
('228994','03/06/2023'),
('229004','03/06/2023'),
('229012','03/06/2023'),
('229016','03/06/2023'),
('229061','03/06/2023'),
('229096','03/06/2023'),
('229103','03/06/2023'),
('229188','03/06/2023'),
('229237','03/06/2023'),
('229408','03/06/2023'),
('229852','03/06/2023'),
('229966','03/06/2023'),
('229970','03/06/2023'),
('230329','03/06/2023'),
('230468','03/06/2023'),
('230469','03/06/2023'),
('230520','03/06/2023'),
('231118','03/06/2023'),
('231149','03/06/2023'),
('231200','03/06/2023'),
('231287','03/06/2023'),
('231326','03/06/2023'),
('231393','03/06/2023'),
('231409','03/06/2023'),
('231415','03/06/2023'),
('231547','03/06/2023'),
('231721','03/06/2023'),
('231845','03/06/2023'),
('231877','03/06/2023'),
('231890','03/06/2023'),
('232046','03/06/2023'),
('232329','03/06/2023'),
('232331','03/06/2023'),
('232340','03/06/2023'),
('232370','03/06/2023'),
('232408','03/06/2023'),
('232422','03/06/2023'),
('232432','03/06/2023'),
('232553','03/06/2023'),
('232631','03/06/2023'),
('233011','03/06/2023'),
('233039','03/06/2023'),
('233091','03/06/2023'),
('233109','03/06/2023'),
('233124','03/06/2023'),
('233129','03/06/2023'),
('233325','03/06/2023'),
('233353','03/06/2023'),
('233378','03/06/2023'),
('233548','03/06/2023'),
('233646','03/06/2023'),
('233758','03/06/2023'),
('233772','03/06/2023'),
('233898','03/06/2023'),
('233951','03/06/2023'),
('234074','03/06/2023'),
('234203','03/06/2023'),
('234234','03/06/2023'),
('234319','03/06/2023'),
('234358','03/06/2023'),
('234367','03/06/2023'),
('234426','03/06/2023'),
('234635','03/06/2023'),
('234703','03/06/2023'),
('234839','03/06/2023'),
('234964','03/06/2023'),
('235097','03/06/2023'),
('235126','03/06/2023'),
('235288','03/06/2023'),
('235316','03/06/2023'),
('235358','03/06/2023'),
('235406','03/06/2023'),
('235498','03/06/2023'),
('235506','03/06/2023'),
('235516','03/06/2023'),
('235623','03/06/2023'),
('235771','03/06/2023'),
('236067','03/06/2023'),
('236069','03/06/2023'),
('236188','03/06/2023'),
('236273','03/06/2023'),
('236497','03/06/2023'),
('236533','03/06/2023'),
('236547','03/06/2023'),
('236769','03/06/2023'),
('236771','03/06/2023'),
('236944','03/06/2023'),
('237054','03/06/2023'),
('237522','03/06/2023'),
('237794','03/06/2023'),
('237871','03/06/2023'),
('237997','03/06/2023'),
('238515','03/06/2023'),
('238637','03/06/2023'),
('238658','03/06/2023'),
('238737','03/06/2023'),
('238745','03/06/2023'),
('238831','03/06/2023'),
('238857','03/06/2023'),
('238935','03/06/2023'),
('239066','03/06/2023'),
('239415','03/06/2023'),
('240001','03/06/2023'),
('240099','03/06/2023'),
('240105','03/06/2023'),
('240150','03/06/2023'),
('240316','03/06/2023'),
('240528','03/06/2023'),
('240651','03/06/2023'),
('240760','03/06/2023'),
('241076','03/06/2023'),
('241339','03/06/2023'),
('241367','03/06/2023'),
('241649','03/06/2023'),
('241682','03/06/2023'),
('241803','03/06/2023'),
('241805','03/06/2023'),
('242264','03/06/2023'),
('242539','03/06/2023'),
('242771','03/06/2023'),
('243147','03/06/2023'),
('243328','03/06/2023'),
('243996','03/06/2023'),
('244102','03/06/2023'),
('244210','03/06/2023'),
('244419','03/06/2023'),
('244557','03/06/2023'),
('245566','03/06/2023'),
('245666','03/06/2023'),
('245909','03/06/2023'),
('246000','03/06/2023'),
('246208','03/06/2023'),
('246500','03/06/2023'),
('246515','03/06/2023'),
('246803','03/06/2023'),
('246804','03/06/2023'),
('246812','03/06/2023'),
('247037','03/06/2023'),
('247373','03/06/2023'),
('248722','03/06/2023'),
('248728','03/06/2023'),
('248742','03/06/2023'),
('249253','03/06/2023'),
('249343','03/06/2023'),
('249639','03/06/2023'),
('250820','03/06/2023'),
('250855','03/06/2023'),
('250867','03/06/2023'),
('250955','03/06/2023'),
('251420','03/06/2023'),
('251516','03/06/2023'),
('252016','03/06/2023'),
('252633','03/06/2023'),
('252794','03/06/2023'),
('252985','03/06/2023'),
('253584','03/06/2023'),
('253586','03/06/2023'),
('253603','03/06/2023'),
('253605','03/06/2023'),
('256652','03/06/2023'),
('256689','03/06/2023'),
('256697','03/06/2023'),
('256705','03/06/2023'),
('256734','03/06/2023'),
('256744','03/06/2023'),
('256745','03/06/2023'),
('256754','03/06/2023'),
('257698','03/06/2023'),
('257742','03/06/2023'),
('257757','03/06/2023'),
('257768','03/06/2023'),
('257838','03/06/2023'),
('257892','03/06/2023'),
('257893','03/06/2023'),
('258060','03/06/2023'),
('258064','03/06/2023'),
('258075','03/06/2023'),
('258153','03/06/2023'),
('258154','03/06/2023'),
('258182','03/06/2023'),
('258526','03/06/2023'),
('258540','03/06/2023'),
('258578','03/06/2023'),
('258595','03/06/2023'),
('258608','03/06/2023'),
('258640','03/06/2023'),
('258660','03/06/2023'),
('258677','03/06/2023'),
('258764','03/06/2023'),
('258838','03/06/2023'),
('258913','03/06/2023'),
('258921','03/06/2023'),
('258952','03/06/2023'),
('258967','03/06/2023'),
('258987','03/06/2023'),
('258999','03/06/2023'),
('259003','03/06/2023'),
('259025','03/06/2023'),
('259054','03/06/2023'),
('259058','03/06/2023'),
('259064','03/06/2023'),
('259082','03/06/2023'),
('259083','03/06/2023'),
('259088','03/06/2023'),
('259114','03/06/2023'),
('259117','03/06/2023'),
('259149','03/06/2023'),
('259153','03/06/2023'),
('259163','03/06/2023'),
('259167','03/06/2023'),
('259178','03/06/2023'),
('259184','03/06/2023'),
('259196','03/06/2023'),
('259234','03/06/2023'),
('259241','03/06/2023'),
('259259','03/06/2023'),
('259269','03/06/2023'),
('259271','03/06/2023'),
('259278','03/06/2023'),
('259418','03/06/2023'),
('259429','03/06/2023'),
('259444','03/06/2023'),
('259448','03/06/2023'),
('259456','03/06/2023'),
('259458','03/06/2023'),
('259463','03/06/2023'),
('259466','03/06/2023'),
('259470','03/06/2023'),
('259481','03/06/2023'),
('259489','03/06/2023'),
('259492','03/06/2023'),
('259496','03/06/2023'),
('259498','03/06/2023'),
('259504','03/06/2023'),
('259505','03/06/2023'),
('259507','03/06/2023'),
('259508','03/06/2023'),
('259519','03/06/2023'),
('259523','03/06/2023'),
('259529','03/06/2023'),
('259543','03/06/2023'),
('259545','03/06/2023'),
('259553','03/06/2023'),
('259555','03/06/2023'),
('259570','03/06/2023'),
('259573','03/06/2023'),
('259574','03/06/2023'),
('259578','03/06/2023'),
('259580','03/06/2023'),
('259585','03/06/2023'),
('259588','03/06/2023'),
('259589','03/06/2023'),
('259593','03/06/2023'),
('259594','03/06/2023'),
('259596','03/06/2023'),
('259604','03/06/2023'),
('259618','03/06/2023'),
('259624','03/06/2023'),
('259625','03/06/2023'),
('259629','03/06/2023'),
('259632','03/06/2023'),
('259634','03/06/2023'),
('259636','03/06/2023'),
('259641','03/06/2023'),
('259644','03/06/2023'),
('259646','03/06/2023'),
('259649','03/06/2023'),
('259653','03/06/2023'),
('259656','03/06/2023'),
('259658','03/06/2023'),
('259660','03/06/2023'),
('259661','03/06/2023'),
('259665','03/06/2023'),
('259668','03/06/2023'),
('259676','03/06/2023'),
('259679','03/06/2023'),
('259680','03/06/2023'),
('259683','03/06/2023'),
('259684','03/06/2023'),
('259686','03/06/2023'),
('259688','03/06/2023'),
('259690','03/06/2023'),
('259707','03/06/2023'),
('259710','03/06/2023'),
('259711','03/06/2023'),
('259727','03/06/2023'),
('259732','03/06/2023'),
('259738','03/06/2023'),
('259740','03/06/2023'),
('259742','03/06/2023'),
('259743','03/06/2023'),
('259744','03/06/2023'),
('259750','03/06/2023'),
('259752','03/06/2023'),
('259754','03/06/2023'),
('259760','03/06/2023'),
('259763','03/06/2023'),
('259774','03/06/2023'),
('259775','03/06/2023'),
('259786','03/06/2023'),
('259788','03/06/2023'),
('259789','03/06/2023'),
('259791','03/06/2023'),
('259792','03/06/2023'),
('259795','03/06/2023'),
('259799','03/06/2023'),
('259800','03/06/2023'),
('259802','03/06/2023'),
('259804','03/06/2023'),
('259816','03/06/2023'),
('259824','03/06/2023'),
('259830','03/06/2023'),
('259837','03/06/2023'),
('259842','03/06/2023'),
('259845','03/06/2023'),
('259853','03/06/2023'),
('259854','03/06/2023'),
('259864','03/06/2023'),
('259866','03/06/2023'),
('259868','03/06/2023'),
('259870','03/06/2023'),
('259873','03/06/2023'),
('259874','03/06/2023'),
('259881','03/06/2023'),
('259882','03/06/2023'),
('259883','03/06/2023'),
('259886','03/06/2023'),
('259888','03/06/2023'),
('259891','03/06/2023'),
('259897','03/06/2023'),
('259900','03/06/2023'),
('259904','03/06/2023'),
('259908','03/06/2023'),
('259911','03/06/2023'),
('259914','03/06/2023'),
('259926','03/06/2023'),
('259934','03/06/2023'),
('259938','03/06/2023'),
('259941','03/06/2023'),
('259942','03/06/2023'),
('259947','03/06/2023'),
('259955','03/06/2023'),
('259960','03/06/2023'),
('259965','03/06/2023'),
('259976','03/06/2023'),
('259985','03/06/2023'),
('259986','03/06/2023'),
('259987','03/06/2023'),
('260002','03/06/2023'),
('351323','03/06/2023'),
('226996','03/07/2023'),
('228284','03/07/2023'),
('229120','03/07/2023'),
('230751','03/07/2023'),
('235272','03/07/2023'),
('235928','03/07/2023'),
('237430','03/07/2023'),
('239193','03/07/2023'),
('244898','03/07/2023'),
('251952','03/07/2023'),
('258185','03/07/2023'),
('259419','03/07/2023'),
('259506','03/07/2023'),
('259557','03/07/2023'),
('259808','03/07/2023'),
('259826','03/07/2023'),
('259931','03/07/2023'),
('226291','03/08/2023'),
('228126','03/08/2023'),
('229867','03/08/2023'),
('230482','03/08/2023'),
('231641','03/08/2023'),
('231726','03/08/2023'),
('232196','03/08/2023'),
('232308','03/08/2023'),
('234725','03/08/2023'),
('237304','03/08/2023'),
('238091','03/08/2023'),
('240734','03/08/2023'),
('240949','03/08/2023'),
('245674','03/08/2023'),
('257847','03/08/2023'),
('258813','03/08/2023'),
('259067','03/08/2023'),
('259431','03/08/2023'),
('259603','03/08/2023'),
('259725','03/08/2023'),
('259905','03/08/2023'),
('259982','03/08/2023'),
('259156','03/09/2023'),
('226374','03/10/2023'),
('230938','03/10/2023'),
('232665','03/10/2023'),
('234042','03/10/2023'),
('234817','03/10/2023'),
('235825','03/10/2023'),
('252687','03/10/2023'),
('253595','03/10/2023'),
('257815','03/10/2023'),
('258996','03/10/2023'),
('259486','03/10/2023'),
('259491','03/10/2023'),
('227585','03/13/2023'),
('233950','03/13/2023'),
('235200','03/13/2023'),
('236867','03/13/2023'),
('239975','03/13/2023'),
('241333','03/13/2023'),
('243366','03/13/2023'),
('251521','03/13/2023'),
('257822','03/13/2023'),
('258629','03/13/2023'),
('258930','03/13/2023'),
('258990','03/13/2023'),
('259517','03/13/2023'),
('259559','03/13/2023'),
('259597','03/13/2023'),
('259721','03/13/2023'),
('259841','03/13/2023'),
('239976','03/14/2023'),
('240230','03/14/2023'),
('243772','03/14/2023'),
('249372','03/14/2023'),
('258632','03/14/2023'),
('258791','03/14/2023'),
('239059','03/15/2023'),
('250562','03/15/2023'),
('251535','03/15/2023'),
('259672','03/15/2023'),
('228904','03/16/2023'),
('229848','03/16/2023'),
('231804','03/16/2023'),
('259999','03/16/2023'),
('259936','03/17/2023'),
('234187','03/20/2023'),
('227138','03/20/2023'),
('233667','03/20/2023'),
('244900','03/20/2023'),
('259898','03/20/2023'),
('239060','03/20/2023'),
('226159','03/21/2023'),
('227143','03/22/2023'),
('240084','03/22/2023'),
('228095','03/22/2023'),
('232275','03/22/2023'),
('231795','03/22/2023'),
('232013','03/22/2023'),
('233143','03/22/2023'),
('230453','03/22/2023'),
('227047','03/22/2023'),
('234238','03/22/2023'),
('256782','03/22/2023'),
('237387','03/23/2023'),
('258143','03/23/2023'),
('242437','03/23/2023'),
('230122','03/24/2023'),
('231638','03/24/2023'),
('231751','03/24/2023'),
('233111','03/24/2023'),
('252568','03/24/2023'),
('253743','03/24/2023'),
('237807','03/27/2023'),
('230548','03/27/2023'),
('259015','03/27/2023'),
('236327','03/27/2023'),
('227834','03/28/2023'),
('231998','03/28/2023'),
('243395','03/28/2023'),
('259877','03/28/2023'),
('227126','03/29/2023'),
('269254','03/29/2023'),
('349502','03/29/2023'),
('351167','03/29/2023');


IF OBJECT_ID('tempdb..#rtemp') IS NOT NULL
    DROP TABLE #rtemp;
select  a.loan_skey,
--a.original_loan_number, 
a.loan_sub_status_description as loan_sub_status,a.investor_name,a.loan_status_description,
c.contact_type_description as 'CONTACTTYPE1'
,c.first_name as 'CONTACTFIRSTNAME1',c.last_name as 'CONTACTLASTNAME1' 
,b.address1 as 'PROPERTYADDRESS1',b.address2 as 'PROPERTYADDRESS2' ,b.city as 'PROPERTYCITY' 
,b.state_code as 'PROPERTYSTATE',left(b.zip_code,5) as 'PROPERTYZIP'
,c.mail_address1 as 'MAILINGADDRESS1' ,c.mail_address2 as 'MAILINGADDRESS2',c.mail_city as 'MAILINGCITY'
,c.mail_state_code as 'MAILINGSTATE' ,left(c.mail_zip_code,5) as 'MAILINGZIP',c.home_phone_number as 'HOMEPHONE1',c.cell_phone_number as 'CELLPHONE1'
,c.work_phone_number as 'Work Phone #'
--,b.curtailment_reason_description,b.date_foreclosure_sale_held,b.date_foreclosure_sale_scheduled
,d.alert_type_description
,d.alert_status_description
,case when c.contact_type_description = 'Attorney' then 1
	  when c.contact_type_description = 'Borrower' then 2
	  when c.contact_type_description = 'Co-Borrower' then 3
	  when c.contact_type_description = 'Legal Owner' then 5
	  when c.contact_type_description = 'Entitled Non-Borrowing Spouse' then 6
	  when c.contact_type_description = 'Alternate Contact' then 14
	  when c.contact_type_description = 'Authorized Party' then 12
	  when c.contact_type_description = 'Executor' then 7
	  when c.contact_type_description = 'Power of Attorney' then 8
	  when c.contact_type_description = 'Trustee' then 11
	  when c.contact_type_description = 'Non-Borrowing Spouse' then 13
	  when c.contact_type_description = 'Conservator' then 9
	  when c.contact_type_description = 'Guardian' then 10
	  when c.contact_type_description = 'Authorized Designee' then 4
	 END as Priority
into #rtemp
from reversequest.rms.v_LoanMaster a
join
[ReverseQuest].[rms].[v_PropertyMaster] b
on a.loan_skey=b.loan_skey
join reversequest.rms.v_ContactMaster c
on a.loan_skey = c.loan_skey
join reversequest.rms.v_Alert d
on a.loan_skey=d.loan_skey
where 
--a.loan_status_description in ('DEFAULT', 'FORECLOSURE') and
 c.contact_type_description not in('Broker',
'  Counseling Agency',
'  Contractor',
'  Debt Counselor',
'  HOA',
'  Neighbor',
'  Other',
'  Payoff Requester',
'  Relative',
'  Skip Tracing',
'  Title Company')
and ((len(c.home_phone_number)>=10 and c.home_phone_number <>'9999999999' and c.home_phone_number <> '4444444444')or (len(c.cell_phone_number)>=10 and c.cell_phone_number <> '9999999999' and c.cell_phone_number <> '4444444444') or
(len(c.work_phone_number)>=10) and c.work_phone_number <> '9999999999' and c.work_phone_number <> '4444444444')
and d.alert_status_description = 'Active';


IF OBJECT_ID('tempdb..#rtemp1') IS NOT NULL
    DROP TABLE #rtemp1;

SELECT a.LoanSkey
		,c.loan_status_description as 'Current Loan Status'
      ,[audit_type_description]
      --,[column_name]
      ,[original_value]
      ,[new_value]
      ,b.[created_date] as 'Change Date'
	  into #rtemp1
  FROM 
  #TempTable a left join
  (select loan_skey, audit_type_description,original_value,new_value,created_date
   from [ReverseQuest].[rms].[v_LogColumnDataChange]
   where audit_type_description = 'Loan Status'
  and original_value like 'Default%'
  and created_date >=Convert(datetime, '2023-03-1')
   ) b on a.LoanSkey=b.loan_skey
   join [ReverseQuest].[rms].[v_LoanMaster] c
   on a.LoanSkey=c.loan_skey
  order by a.LoanSkey,b.created_date
  ;


  IF OBJECT_ID('tempdb..#rtemp2') IS NOT NULL
    DROP TABLE #rtemp2;
  select a.LoanSkey,'Loan Status' as 'Field',a.[Current Loan Status],a.original_value
  ,a.new_value,a.[Change Date]
  ,b.workflow_type_description as 'Active Loss Mitigation workflow'
  ,case when(b.workflow_type_description) is null then 'N' else 'Y' end as 'Active Workflow'
  into #rtemp2
   from #rtemp1 a
  left join
  [ReverseQuest].[rms].[v_WorkflowInstance] b
  on a.LoanSkey=b.loan_skey
  and b.status_description = 'Active' and workflow_type_description in
  ('Repayment Plan','Loss Mit-Short Sale','Loss Mit-Family Sale Pending'
  ,'Extension - At Risk','Extension - COVID-19 Request to Delay Claims Submission','Extension - COVID-19 Request to Delay Due & Payable',
  'Extension - COVID-19 Request to Delay Foreclosure','Extension - Deed-in-Lieu','Extension - Hardest Hit Fund (HHF)','Extension - Property Charge Loss Mitigation'
  ,'Loss Mitigation - Deed in Lieu','Loss Mitigation - Family Sale Pending','Loss Mitigation - Short Sale');

  IF OBJECT_ID('tempdb..#rtemp3') IS NOT NULL
    DROP TABLE #rtemp3;
  select a.*,
  c.alert_type_description as 'Non-Workable Reason', case when c.alert_type_description is null then 'Y' else 'N' end as 'Workable'
  ,(select count(loan_skey)  from reversequest.rms.v_note 
  where loan_skey = a.LoanSkey and( note_type_description like '%Incom%'  or  note_type_description like 'Spoc Incom%')
  and created_date >=   DATEADD(DAY, DATEDIFF(DAY, 30, GETDATE()), 0)) as 'Inbound Calls in 30 days'
  ,(select count(loan_skey)  from reversequest.rms.v_note 
  where loan_skey = a.LoanSkey and( (note_type_description like '%Outgoing%'  or  note_type_description like 'Spoc Outgoing%') and note_type_description <> 'Outgoing Letter')
  and created_date >=   DATEADD(DAY, DATEDIFF(DAY, 30, GETDATE()), 0)) as 'Outbound Calls in 30 days'
  into #rtemp3
   from #rtemp2 a
  left join (select * from [ReverseQuest].[rms].[v_Alert]  where loan_skey in 
   (select loan_skey from #rtemp2) and alert_type_description 
   in ('FDCPA -  Call Restrictions','Cease and Desist','Pending Cease and Desist','LITIGATION - Lawsuit Pending','DVN Research Request Pend',
'Identity Theft','Fraud Suspicion','DVN Research Request Pend','SKPADD','SKPEML','SKPEXH','SKPTRC') 
   and alert_status_description = 'Active' ) c
  on a.LoanSkey=c.loan_skey;

  select a.*,a.[Inbound Calls in 30 days]+a.[Outbound Calls in 30 days] as 'IB+OB Attempts in last 30 days'
  ,case when a.LoanSkey in (select loan_skey from #rtemp) then 1 else 0 end as 'Dialable' 
   from #rtemp3 a;

 select * from #rtemp where loan_skey = '229061';